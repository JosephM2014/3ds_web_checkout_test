<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Encrypted checkout sample</title>
    <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="js/songbird_v1.js"></script>
    <script type="text/javascript" src="js/enc_checkout.js"></script>
    <script type="text/javascript" src="js/crypto-js/crypto-js.js"></script>
</head>
<body>
<script>
    function encrypt(msg, pass) {
        //Create random salt to strengthen key
        const salt = CryptoJS.lib.WordArray.random(128 / 8);

        //Generate stronger 256 bit key based on given password and random salt
        const key = CryptoJS.PBKDF2(pass, salt, {
            keySize: 256 / 32,
            iterations: 1024
        });

        //Create random 128 bit iv for 16 byte aes block
        const iv = CryptoJS.lib.WordArray.random(128 / 8);

        const encrypted = CryptoJS.AES.encrypt(msg, key, {
            iv: iv,
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC
        });

        // Return encrypted result together with key and iv for use in decryption
        return {
            key: key.toString(), // 256 bit key in hex (64 chars)
            iv: iv.toString(), // 128 bit IV in hex (32 chars)
            encrypted: encrypted.toString() // Base64 encoded string of the encrypted data
        };
    }

    function decrypt(encrypted, key, iv) {
        console.log(encrypted, key, iv);
        return CryptoJS.AES.decrypt(encrypted, CryptoJS.enc.Hex.parse(key), {
            iv: CryptoJS.enc.Hex.parse(iv),
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC
        });
    }

    function doEncrypt() {
        const payload = $('#payload').val();
        const password = $('#password').val();
        let result = encrypt(payload, password);
        console.log(result);
        $('#encrypted').text(result.encrypted);
        $('#key').text(result.key);
        $('#iv').text(result.iv);
    }

    function doDecrypt() {
        let encrypted = $('#encrypted').text();
        const key = $('#key').text();
        const iv = $('#iv').text();
        let decrypted = decrypt(encrypted, key, iv);
        console.log(decrypted.toString(CryptoJS.enc.Utf8));
        $('#decrypted').text("Decrypted: " + decrypted.toString(CryptoJS.enc.Utf8));
    }

    function pay() {
        const payload = $('#payload').val();
        const password = $('#password').val();
        let result = encrypt(payload, password);
        makeCardPayment(result, successCallback, failureCallback)
    }

    let successCallback = function (result) {
        console.log(result);
        alert("Result:" + result.value);
    };
    let failureCallback = function (error) {
        console.log(error);
        alert("Error:" + error);
    };
</script>
<div>
    <button onclick="pay()">Pay</button>
</div>
<div style="display: flex; max-width: 100%">
    <div style="flex-basis: 50%; flex-grow: 0; display: flex; flex-direction: column">
        <button onclick="doEncrypt()">Encrypt</button>
        <form>
            <label for="payload">Payload</label>
            <textarea id="payload" placeholder="payload">{"secureData":"33cf690ddc6d4066f2c54b1ad0b565d38299117c201720218146a5af43ce5e4f3c7edabfae48745e8a5c603c7496b118b87f81b7017c9f07fb7b105ab214968e45391c6a6d6307ad26db2a8edc0add39d5895a09e3a7c5b0a98563fd3ee9566a9fe7576ffedb07f4bbbea156c9f9565138e36ff2293083b6c9f0e6506d2cc83a901355fbc29e007a77c33fa2d7d59253a7160cfa91327cea1098efb5d6dc443f027df4d5dba464a8e1c9cdec904766a4235fc8b80e582cc27564399aa711595920a01d7f418607f8285ac4f758cfa6b323c116ad192188f69ec5b522d743c8d986e42923b6947eae5ffdcf7231b856f89b1f31bd932f6ebfb81ac230d37c4e01","pinBlock":"b581e06d1d0567cd","authData":"KV1Dt2jMiGDws+fp/emlGTbwUFcX+Rw9YxNGMcOGSJT6t0r9J5nYpwR8CSq5oMuRJJXwnxD9exQGIAXZLG147w6R/mWk+oqzxrPPbiri88We3hb4yXA62xhSWgqk7iwVo2vCcSJSIr/MBsIvu0fsmdQojz8eKUtPA+tOjIdBTSiS6dYcJYmWI8/cdZ+HcXCMUBa1u5y5zxcqSymYXj+PomfeWs1/v9uuLW/Jnu4mG3qItGkiAbbfKVA8Vl6LePTY6ocarltJ0SiXm9/ac8uMHrJYuHFyRPRsKgrzxwIAi7Vas/Xe+VgbOHe/JMGsMeiR0m8/rkHIqLtnoBFt0e111A==","paymentId":200,"amount":"100","transactionRef":"DeChRef_202001131440_srj","terminalType":"WEB","terminalId":"3TLP0001","paymentItem":"CRD","provider":"VRI","merchantId":"ISWKEN0001","customerInfor":"1002|kelvin|mwangi| kelvin.mwangi@interswitchgroup.com |0714171282|NBI|KE|00200|wstlnds|NBI||testmerchant.interswitch-ke.com |Firefox","orderId":"DeChOid_202001131440_cCH","currencyCode":"KES","currency":"KES","domain":"ISWKE","narration":"Payment","fee":"0","preauth":"0","paca":"1"}</textarea>
            <label for="password">Password</label>
            <input type="text" id="password" placeholder="password" value="Secret Password">
        </form>
        <p id="encrypted" style="overflow: scroll"></p>
    </div>
    <div style="flex-basis: 50%; flex-grow: 0; display: flex; flex-direction: column">
        <button onclick="doDecrypt()">Decrypt</button>
        <p id="key"></p>
        <p id="iv"></p>
        <p id="decrypted"></p>
    </div>
</div>
</body>
</html>